package com.handlerexploit.recoveryflasher.utils;

import java.io.File;
import java.io.FileInputStream;
import java.io.FileNotFoundException;
import java.io.IOException;
import java.net.MalformedURLException;
import java.net.URL;

import org.apache.commons.codec.copy.digest.DigestUtils;
import org.apache.commons.io.copy.FileUtils;
import org.apache.commons.io.copy.IOUtils;
import org.json.JSONArray;
import org.json.JSONException;
import org.json.JSONObject;

import android.content.Context;
import android.os.Environment;

import com.handlerexploit.recoveryflasher.activities.DevicesActivity.Device;
import com.handlerexploit.recoveryflasher.models.ExtendedDevice;
import com.handlerexploit.recoveryflasher.models.Recovery;

public class Parser {
    
    private String mDownloadDirectory;
    private boolean mForceExpire;
    
    public Parser(Context context) {
        this(context, false);
    }
    
    public Parser(Context context, boolean forceExpire) {
        this.mDownloadDirectory = Environment.getDataDirectory().getPath() + "/data/" + context.getPackageName() + "/cache/";
        this.mForceExpire = forceExpire;
    }
    
    public ExtendedDevice requestExtendedDevice(Device device) {
        ExtendedDevice extendedDevice = new ExtendedDevice(device);
        try {
            File cachedResponse = downloadToFile(device.getUrl(), mDownloadDirectory, mForceExpire);
            String rawJson = IOUtils.toString(new FileInputStream(cachedResponse));
            JSONObject root = new JSONObject(rawJson);
            JSONArray recoverylist = root.getJSONArray("recoverylist");
            for (int i = 0; i < recoverylist.length(); i++) {
                JSONObject jsonObject = recoverylist.getJSONObject(i);
                
                Recovery recovery = new Recovery();
                recovery.setTitle(jsonObject.getString("title"));
                recovery.setDesc(jsonObject.getString("desc"));
                recovery.setIconUrl(jsonObject.getString("icon_url"));
                recovery.setIcon(downloadToFile(recovery.getIconUrl(), mDownloadDirectory, mForceExpire));
                recovery.setDownloadUrl(jsonObject.getString("url"));
                
                extendedDevice.addRecovery(recovery);
            }
        } catch (FileNotFoundException e) {
            e.printStackTrace();
        } catch (IOException e) {
            e.printStackTrace();
        } catch (JSONException e) {
            e.printStackTrace();
        }
        return extendedDevice;
    }
    
    private static boolean isExpired(File file, boolean forceExpire) {
         return forceExpire || !file.exists() || file.exists() && System.currentTimeMillis() > file.lastModified() + 86400000;
    }
    
    private static File downloadToFile(String url, String downloadDirectory, boolean forceExpire) {
        File file = new File(downloadDirectory + DigestUtils.sha256Hex(url));
        if (isExpired(file, forceExpire)) {
            Exception exception = null;
            try {
                FileUtils.copyURLToFile(new URL(url), file);
            } catch (MalformedURLException e) {
                exception = e;
            } catch (IOException e) {
                exception = e;
            } finally {
                if (exception != null) {
                    file.delete();
                    exception.printStackTrace();
                }
            }
        }
        return file;
    }
}