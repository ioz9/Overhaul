package com.handlerexploit.recoveryflasher;

import java.io.IOException;

import org.apache.http.ParseException;
import org.apache.http.client.ClientProtocolException;
import org.apache.http.client.methods.HttpGet;
import org.apache.http.impl.client.DefaultHttpClient;
import org.apache.http.util.EntityUtils;
import org.json.JSONArray;
import org.json.JSONException;
import org.json.JSONObject;

import com.handlerexploit.recoveryflasher.MainActivity.Device;
import com.handlerexploit.recoveryflasher.models.ExtendedDevice;
import com.handlerexploit.recoveryflasher.models.Recovery;

public class Parser {
    
    public static ExtendedDevice requestExtendedDevice(Device device) {
        ExtendedDevice extendedDevice = new ExtendedDevice(device);
        
        try {
            String rawJson = requestEntity(extendedDevice.getUrl());
            JSONObject root = new JSONObject(rawJson);
            JSONArray recoverylist = root.getJSONArray("recoverylist");
            for (int i = 0; i < recoverylist.length(); i++) {
                JSONObject jsonObject = recoverylist.getJSONObject(i);
                
                Recovery recovery = new Recovery();
                recovery.setTitle(jsonObject.getString("title"));
                recovery.setDesc(jsonObject.getString("desc"));
                recovery.setIconUrl(jsonObject.getString("icon_url"));
                recovery.setUrl(jsonObject.getString("url"));
                
                extendedDevice.addRecovery(recovery);
            }
        } catch (ParseException e) {
            e.printStackTrace();
        } catch (ClientProtocolException e) {
            e.printStackTrace();
        } catch (IOException e) {
            e.printStackTrace();
        } catch (JSONException e) {
            e.printStackTrace();
        }
        
        return extendedDevice;
    }
    
    private static String requestEntity(String url) throws ParseException, ClientProtocolException, IOException {
        return EntityUtils.toString(new DefaultHttpClient().execute(new HttpGet(url)).getEntity());
    }
}